<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8>
	<style>
		body { margin: 0; }
		canvas { width: 100%; height: 100% }
	</style>
</head>
<body>
	<script src="https://sim.e-neutrons.org/static/threejs/three.min.js"></script>
	<script src="https://sim.e-neutrons.org/static/threejs/OrbitControls.js"></script>
	<script src="mcdisplay.js"></script>
	<!--<script src="js/TrackballControls.js"></script>-->
	<script>
		// INSTRUMENT

		{% for comp in instrument.components %}

		comp = addComponent("{{comp.name}}");
		acolor = getNextComponentColor();{% for drawcall in comp.drawcommands %}{% if drawcall.key == 'multiline' %}
		addMultiLine([{{drawcall.args_str}}], comp, acolor);{% endif %}{% if drawcall.key == 'circle' %}
		addCircle({% autoescape off %}{{drawcall.args_str}}{% endautoescape %}, comp, acolor);{% endif %}{% endfor %}
		m4 = new THREE.Matrix4();
		m4.set({{comp.m4_str}});
		comp.applyMatrix(m4);{% endfor %}

		// NEUTRON RAYS
		{% for ray in instrument.rays %}

		rayobj = new THREE.Object3D();
		allRays.push(rayobj);
		aVertices = [];{% for comp_points in ray.events %}
		aCompVertices = [];{% for p in comp_points.1 %}
		aCompVertices.push(new THREE.Vector3({{ p.position.x }}, {{ p.position.y }}, {{ p.position.z }}));{% endfor %}
		aVertices = aVertices.concat(transformPoints(aCompVertices, compnodes["{{comp_points.0}}"].matrix));{% endfor %}
		addMultiLineV3(aVertices, rayobj, rayColor);{% endfor %}

		// show all rays in arrayOfRays
		var showRays = function(arrayOfRays, root)
		{
			for (var i = 0; i < arrayOfRays.length; i++)
			{
				root.add(arrayOfRays[i]);
			}
		}
		// remove all rays in arrayOfRays from scene tree
		var hideRays = function(arrayOfRays, root)
		{
			for (var i = 0; i < arrayOfRays.length; i++)
			{
				root.remove(arrayOfRays[i]);
			}
		}
		//
		iRay = -1;
		var showNextRay = function(arrayOfRays, root)
		{

			lastRay = iRay
			iRay += 1;
			if (iRay >= arrayOfRays.length)
			{
				iRay = 0;
			}
			root.add(arrayOfRays[iRay]);
			root.remove(arrayOfRays[lastRay]);
		}

		//showRays(allRays, root);

		// renderloop
		function render() {
			requestAnimationFrame(render);
			renderer.render(scene, camera);

			showNextRay(allRays, root);
		}
		render();
    </script>
</body>
</html>
