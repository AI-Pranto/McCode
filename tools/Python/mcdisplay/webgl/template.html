<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8>
	<style>
		body { margin: 0; }
		canvas { width: 100%; height: 100% }
	</style>
</head>
<body>
	<script src="js/three.min.js"></script>
	<script src="js/OrbitControls.js"></script>
	<!--<script src="js/TrackballControls.js"></script>-->
	<script>
		// add circle to xy plane
		// 		radius
		// 		center - a THREE.Vector3 instance
		var addCircle = function(radius, center)
		{
			var material = new THREE.MeshBasicMaterial({
				color: 0x0000ff
			});
			var segments = 32;
			var circleGeometry = new THREE.CircleGeometry( radius, segments );
			var circle = new THREE.Mesh( circleGeometry, material );
			circle.position.x = center.x;
			circle.position.y = center.y;
			circle.position.z = center.z;
			scene.add( circle );
		}
		// add sphere
		//		radius
		//		wseg 	- width segments
		//		hseg 	- height segments
		var addSphere = function(radius, wseg, hseg)
		{
			var geometry = new THREE.SphereGeometry(radius, wseg, hseg);
			var material = new THREE.MeshBasicMaterial( {color: 0xffff00} );
			var sphereMaterial = new THREE.MeshLambertMaterial({ color: 0xCC0000 });
			var sphere = new THREE.Mesh( geometry, sphereMaterial );
			scene.add( sphere );
		}
		// add pointlight
		// 		center 	- THREE.Vector3 instance
		var addLight = function(center, scene)
		{
			// pointlight (required to light up sphereMaterial)
			var pointLight = new THREE.PointLight(0xFFFFFF);
			pointLight.position.x = center.x;
			pointLight.position.y = center.y;
			pointLight.position.z = center.z;
			scene.add(pointLight);
		}
		// set scene
		//
		var scene;
		var camera
		var renderer;
		var controls;
		var init = function(rootnode)
		{
			scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
			camera.position.x = -50;
			camera.position.y = 0;
			camera.position.z = 50;

			renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);

			controls = new THREE.OrbitControls(camera);
			controls.target.x = 1;
			controls.target.y = 0;
			controls.target.z = 49;

			//controls = new THREE.TrackballControls(camera);

			//controls.rotateSpeed = 5.0;
			//controls.zoomSpeed = 5;
			//controls.panSpeed = 2;

			//controls.noZoom = false;
			//controls.noPan = false;

			//controls.staticMoving = true;
			//controls.dynamicDampingFactor = 0.3;

			addLight(new THREE.Vector3(10, 50, 130), scene)
			scene.add(rootnode);
		}
		// add multiline
		// 		arrVector3 - an array of THREE.Vector3 instances
		var addMultiLineV3 = function(arrVector3, parent, linecolor)
		{
			console.log(linecolor);
			var multilinematerial = new THREE.LineBasicMaterial({color: linecolor});
			var multilinegeometry = new THREE.Geometry();
			for (var i = 0; i < arrVector3.length; i++)
			{
				multilinegeometry.vertices.push(arrVector3[i]);
			}
			var multiline = new THREE.Line(multilinegeometry, multilinematerial);
			parent.add(multiline);
		}
		// add multiline proxy method
		//		points - array of single points
		var addMultiLine = function(points, parent, linecolor)
		{
			vectors = [];
			for (var i = 0; i < points.length / 3; i++)
			{
				points[i];
				v = new THREE.Vector3(points[i*3], points[i*3+1], points[i*3+2]);
				vectors.push(v);
			}
			addMultiLineV3(vectors, parent, linecolor);
		}
		// add a component origo
		//		pos - position of component ore
		var addComponent = function(compname, m4_str)
		{
			var comp = new THREE.Object3D();
			root.add(comp);

			comps[compname] = comp;
			return comp;
		}

		comps = {};
		var root = new THREE.Object3D();
		var lastComp = root;
		init(root);

		// component draw section
		var m4;
		{% for comp in instrument.components %}
		lastComp = addComponent("{{comp.name}}", {{comp.m4_str}});
			{% for drawcall in comp.drawcommands %}
				{% if drawcall.key == 'multiline' %}addMultiLine([{{drawcall.args_str}}], lastComp, 0x0000ff);{% endif %}
			{% endfor %}
		m4 = new THREE.Matrix4();
		m4.set({{comp.m4_str}});
		lastComp.applyMatrix(m4);
		{% endfor %}

		// TODO: Ray events are in global coordinates from python. This should be changed into local, using "component" events (currently not present)
		var addRay = function()
		{
			var ray = new THREE.Object3D();
			root.add(ray);
			return ray;
		}

		var apos;
		var rayobj;
		// neutron ray data calls
		{% for ray in instrument.rays %}
			rayobj = addRay();
			apos = [];
			{% for event in ray.events %}
				apos.push(new THREE.Vector3({{event.position.x}}, {{event.position.y}}, {{event.position.z}}));{% endfor %}
			addMultiLineV3(apos, rayobj, 0x00ffff);
			console.log(rayobj);{% endfor %}

		// renderloop
		function render() {
			//controls.update();
			requestAnimationFrame(render);
			renderer.render(scene, camera);
		}
		render();
    </script>
</body>
</html>
