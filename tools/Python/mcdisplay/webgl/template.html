<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8>
	<style>
		body { margin: 0; }
		canvas { width: 100%; height: 100% }
	</style>
</head>
<body>
	<script src="js/three.min.js"></script>
	<script src="js/OrbitControls.js"></script>
	<script>
		var currentComp = new THREE.Object3D();
		// add multiline
		// 		arrVector3 - an array of THREE.Vector3 instances
		var addMultiLineV3 = function(arrVector3)
		{
			var multilinematerial = new THREE.LineBasicMaterial({color: 0x0000ff});
			var multilinegeometry = new THREE.Geometry();
			for (var i = 0; i < arrVector3.length; i++)
			{
				multilinegeometry.vertices.push(arrVector3[i]);
			}
			var multiline = new THREE.Line(multilinegeometry, multilinematerial);
			currentComp.children.push(multiline);
		}
		// add a component origo
		//
		var addComp = function(pos)//, rot)
		{
			var comp = new THREE.Object3D();
			comp.position = pos;
			comp.updateMatrix();
			//comp.rotation = rot;
			currentComp.children.push(comp);
			currentComp = comp;
		}
		// add multiline proxy method
		//		points - array of single points
		var addMultiLineProxy = function(points)
		{
			vectors = [];
			for (var i = 0; i < points.length / 3; i++)
			{
				points[i];
				v = new THREE.Vector3(points[i*3], points[i*3+1], points[i*3+2]);
				vectors.push(v);
			}
			addMultiLineV3(vectors);
		}
		// add circle to xy plane
		// 		radius
		// 		center - a THREE.Vector3 instance
		var addCircle = function(radius, center)
		{
			var material = new THREE.MeshBasicMaterial({
				color: 0x0000ff
			});
			var segments = 32;
			var circleGeometry = new THREE.CircleGeometry( radius, segments );
			var circle = new THREE.Mesh( circleGeometry, material );
			circle.position.x = center.x;
			circle.position.y = center.y;
			circle.position.z = center.z;
			scene.add( circle );
		}
		// add sphere
		//		radius
		//		wseg 	- width segments
		//		hseg 	- height segments
		var addSphere = function(radius, wseg, hseg)
		{
			var geometry = new THREE.SphereGeometry(radius, wseg, hseg);
			var material = new THREE.MeshBasicMaterial( {color: 0xffff00} );
			var sphereMaterial = new THREE.MeshLambertMaterial({ color: 0xCC0000 });
			var sphere = new THREE.Mesh( geometry, sphereMaterial );
			scene.add( sphere );
		}
		// add pointlight
		// 		center 	- THREE.Vector3 instance
		var addLight = function(center)
		{
	        // pointlight (required to light up sphereMaterial)
	        var pointLight = new THREE.PointLight(0xFFFFFF);
	        pointLight.position.x = center.x;
	        pointLight.position.y = center.y;
	        pointLight.position.z = center.z;
	        scene.add(pointLight);
		}

		// set scene
		var scene = new THREE.Scene();
		var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
		var renderer = new THREE.WebGLRenderer();
		renderer.setSize(window.innerWidth, window.innerHeight);
		document.body.appendChild(renderer.domElement);
		camera.position.z = 1;
		controls = new THREE.OrbitControls( camera );
		addLight(new THREE.Vector3(10, 50, 130))
		scene.add(currentComp);

		// component rendering calls
		{% for comp in instrument.components %}
		
		addComp(new THREE.Vector3({{ comp.pos.x }}, {{ comp.pos.y }}, {{ comp.pos.z }}));
		{% for drawcall in comp.drawcommands %}{% if drawcall.key == 'multiline' %}
		addMultiLineProxy([{{drawcall.args_str}}]);{% endif %}{% endfor %}{% endfor %}

		// neutron ray data calls
		{% for ray in instrument.rays %}{% endfor %}

		// renderloop
		function render() {
			requestAnimationFrame( render );
			renderer.render( scene, camera );
		}
		render();
    </script>
</body>
</html>
